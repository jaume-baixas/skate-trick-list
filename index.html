import React, { useState, useEffect } from 'react';
import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js';
import { getDatabase, ref, set, get } from 'https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js';

const firebaseConfig = {
  apiKey: "AIzaSyDS6yD7l5WHJWylq0fdBaq7zaEV3ahInIs",
  authDomain: "skate-tricks-list.firebaseapp.com",
  databaseURL: "https://skate-tricks-list-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "skate-tricks-list",
  storageBucket: "skate-tricks-list.firebasestorage.app",
  messagingSenderId: "1038259811397",
  appId: "1:1038259811397:web:9534d8788f389c772d9f2c"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const GROUPS = {
  flatground: 'Flatground',
  slides: 'Slides',
  grinds: 'Grinds',
  spins: 'Spins',
  transition: 'Transition/Ramp',
  combo: 'Combo'
};

export default function TrucksApp() {
  const [allData, setAllData] = useState({
    currentSkater: 'default',
    skaters: {
      'default': {
        name: 'Skater 1',
        age: null,
        sessions: ['SessiÃ³ 1', 'SessiÃ³ 2'],
        tricks: [
          { name: 'Ollie', level: 'facil', group: 'flatground', attempts: {} },
          { name: 'Kickflip', level: 'mitja', group: 'flatground', attempts: {} }
        ]
      }
    }
  });
  
  const [showMenu, setShowMenu] = useState(false);
  const [modals, setModals] = useState({
    addTrick: false,
    addSession: false,
    addSkater: false,
    editTrick: false,
    editSession: false
  });
  const [editIndex, setEditIndex] = useState(null);
  
  useEffect(() => {
    const dataRef = ref(db, 'allSkaterData');
    get(dataRef).then((snapshot) => {
      if (snapshot.exists()) {
        setAllData(snapshot.val());
      } else {
        saveToFirebase(allData);
      }
    });
  }, []);
  
  const saveToFirebase = (data) => {
    const dataRef = ref(db, 'allSkaterData');
    set(dataRef, data);
    localStorage.setItem('tricksBackup', JSON.stringify(data));
  };
  
  const getCurrentData = () => allData.skaters[allData.currentSkater];
  
  const updateData = (updater) => {
    setAllData(prev => {
      const newData = typeof updater === 'function' ? updater(prev) : updater;
      saveToFirebase(newData);
      return newData;
    });
  };
  
  return (
    <div className="min-h-screen bg-gray-100 p-5 pb-24">
      <div className="max-w-6xl mx-auto bg-white rounded-3xl shadow-lg p-8">
        {/* Header */}
        <div className="flex justify-between items-start mb-8">
          <div className="flex-1">
            <h1 className="text-4xl font-bold text-gray-800 mb-2">ðŸ›¹ Seguiment de Trucs</h1>
            <p className="text-gray-600 mb-4">Registra els teus progressos sessiÃ³ a sessiÃ³</p>
            <div className="flex gap-2 max-w-md">
              <select 
                className="flex-1 px-4 py-2 border-2 border-gray-200 rounded-lg"
                value={allData.currentSkater}
                onChange={(e) => setAllData(prev => ({...prev, currentSkater: e.target.value}))}
              >
                {Object.entries(allData.skaters).map(([id, skater]) => (
                  <option key={id} value={id}>
                    {skater.name}{skater.age ? ` (${skater.age} anys)` : ''}
                  </option>
                ))}
              </select>
              <button 
                className="px-4 py-2 bg-indigo-600 text-white rounded-lg font-bold"
                onClick={() => setModals(prev => ({...prev, addSkater: true}))}
              >
                +
              </button>
              <button 
                className="px-3 py-2 text-gray-400 hover:bg-red-50 hover:text-red-600 rounded-lg transition"
                onClick={() => {
                  if (Object.keys(allData.skaters).length <= 1) {
                    alert('No pots eliminar Ãºnic skater!');
                    return;
                  }
                  if (confirm('Eliminar aquest skater?')) {
                    updateData(prev => {
                      const newSkaters = {...prev.skaters};
                      delete newSkaters[prev.currentSkater];
                      return {
                        ...prev,
                        skaters: newSkaters,
                        currentSkater: Object.keys(newSkaters)[0]
                      };
                    });
                  }
                }}
              >
                âœ•
              </button>
            </div>
          </div>
        </div>

        {/* Action Buttons */}
        <div className="flex gap-2 mb-5">
          <button
            className="px-4 py-2 bg-white border-2 border-gray-200 rounded-lg hover:border-indigo-600"
            onClick={() => setModals(prev => ({...prev, addTrick: true}))}
          >
            âž• Afegir Truc
          </button>
          <button
            className="px-4 py-2 bg-white border-2 border-gray-200 rounded-lg hover:border-indigo-600"
            onClick={() => setModals(prev => ({...prev, addSession: true}))}
          >
            ðŸ“… Afegir SessiÃ³
          </button>
        </div>

        {/* Table */}
        <TricksTable 
          data={getCurrentData()} 
          onUpdate={updateData}
          onEditTrick={(idx) => {
            setEditIndex(idx);
            setModals(prev => ({...prev, editTrick: true}));
          }}
          onEditSession={(idx) => {
            setEditIndex(idx);
            setModals(prev => ({...prev, editSession: true}));
          }}
        />

        {/* Summary */}
        <Summary data={getCurrentData()} />

        {/* Download Button */}
        <div className="fixed bottom-8 right-8">
          <button
            className="w-16 h-16 bg-indigo-600 text-white rounded-full text-2xl shadow-lg hover:bg-indigo-700"
            onClick={() => setShowMenu(!showMenu)}
          >
            â¬‡
          </button>
          {showMenu && (
            <div className="absolute bottom-20 right-0 bg-white rounded-lg shadow-xl overflow-hidden">
              <button className="block w-full px-5 py-3 text-left hover:bg-gray-50" onClick={() => {
                const blob = new Blob([JSON.stringify(allData, null, 2)], {type: 'application/json'});
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = 'trucs.json';
                a.click();
                setShowMenu(false);
              }}>ðŸ’¾ Exportar JSON</button>
            </div>
          )}
        </div>
      </div>

      {/* Modals */}
      {modals.addTrick && <AddTrickModal onClose={() => setModals(prev => ({...prev, addTrick: false}))} onAdd={(trick) => {
        updateData(prev => ({
          ...prev,
          skaters: {
            ...prev.skaters,
            [prev.currentSkater]: {
              ...prev.skaters[prev.currentSkater],
              tricks: [...prev.skaters[prev.currentSkater].tricks, trick]
            }
          }
        }));
        setModals(prev => ({...prev, addTrick: false}));
      }} />}
      
      {modals.addSession && <AddSessionModal onClose={() => setModals(prev => ({...prev, addSession: false}))} onAdd={(name) => {
        updateData(prev => ({
          ...prev,
          skaters: {
            ...prev.skaters,
            [prev.currentSkater]: {
              ...prev.skaters[prev.currentSkater],
              sessions: [...prev.skaters[prev.currentSkater].sessions, name]
            }
          }
        }));
        setModals(prev => ({...prev, addSession: false}));
      }} />}
      
      {modals.addSkater && <AddSkaterModal onClose={() => setModals(prev => ({...prev, addSkater: false}))} onAdd={(skater) => {
        const id = 'skater_' + Date.now();
        updateData(prev => ({
          ...prev,
          currentSkater: id,
          skaters: {
            ...prev.skaters,
            [id]: {
              name: skater.name,
              age: skater.age,
              sessions: ['SessiÃ³ 1'],
              tricks: []
            }
          }
        }));
        setModals(prev => ({...prev, addSkater: false}));
      }} />}
    </div>
  );
}

function TricksTable({ data, onUpdate, onEditTrick, onEditSession }) {
  if (!data) return null;
  
  const grouped = {};
  data.tricks.forEach(trick => {
    const g = trick.group || 'flatground';
    if (!grouped[g]) grouped[g] = [];
    grouped[g].push(trick);
  });
  
  return (
    <div className="overflow-x-auto mb-8 border border-gray-200 rounded-lg">
      <table className="w-full">
        <thead className="bg-gray-50">
          <tr>
            <th className="px-4 py-3 text-left text-sm font-semibold sticky left-0 bg-gray-50 z-10" style={{minWidth: '80px', maxWidth: '80px'}}>Truc</th>
            <th className="px-4 py-3 text-left text-sm font-semibold sticky bg-gray-50 z-10" style={{left: '80px', minWidth: '80px', maxWidth: '80px'}}>Nivell</th>
            {data.sessions.map((s, i) => (
              <th key={i} className="px-4 py-3 text-left text-sm font-semibold bg-gray-50">
                {s} <button className="ml-2 text-gray-400 hover:text-blue-600" onClick={() => onEditSession(i)}>âœŽ</button>
              </th>
            ))}
          </tr>
        </thead>
        <tbody>
          {Object.keys(GROUPS).map(gKey => grouped[gKey] && grouped[gKey].length > 0 && (
            <React.Fragment key={gKey}>
              <tr className="bg-gray-100">
                <td colSpan={2 + data.sessions.length} className="px-4 py-2 font-bold text-indigo-600 text-xs uppercase tracking-wide">
                  {GROUPS[gKey]}
                </td>
              </tr>
              {grouped[gKey].map((trick) => {
                const idx = data.tricks.indexOf(trick);
                const levelColors = {facil: 'bg-green-100 text-green-800', mitja: 'bg-orange-100 text-orange-800', dificil: 'bg-red-100 text-red-800'};
                return (
                  <tr key={idx} className="hover:bg-gray-50">
                    <td className="px-4 py-3 sticky left-0 bg-white" style={{minWidth: '80px', maxWidth: '80px'}}>
                      <strong className="text-sm">{trick.name}</strong>
                      <button className="ml-2 text-gray-400 hover:text-blue-600 text-xs" onClick={() => onEditTrick(idx)}>âœŽ</button>
                    </td>
                    <td className="px-4 py-3 sticky bg-white" style={{left: '80px', minWidth: '80px', maxWidth: '80px'}}>
                      <span className={`px-2 py-1 rounded-full text-xs font-semibold ${levelColors[trick.level]}`}>
                        {trick.level === 'facil' ? 'FÃ cil' : trick.level === 'mitja' ? 'MitjÃ ' : 'DifÃ­cil'}
                      </span>
                    </td>
                    {data.sessions.map((s, si) => (
                      <td key={si} className="px-4 py-3">
                        <select
                          className="px-2 py-1 border-2 border-gray-200 rounded"
                          value={trick.attempts[s] || 'â€”'}
                          onChange={(e) => {
                            const newTricks = [...data.tricks];
                            newTricks[idx].attempts[s] = e.target.value;
                            onUpdate(prev => ({
                              ...prev,
                              skaters: {
                                ...prev.skaters,
                                [prev.currentSkater]: {
                                  ...prev.skaters[prev.currentSkater],
                                  tricks: newTricks
                                }
                              }
                            }));
                          }}
                        >
                          <option>â€”</option>
                          <option>1</option>
                          <option>2</option>
                          <option>3</option>
                          <option>4</option>
                          <option>5</option>
                          <option>+5</option>
                        </select>
                      </td>
                    ))}
                  </tr>
                );
              })}
            </React.Fragment>
          ))}
        </tbody>
      </table>
    </div>
  );
}

function Summary({ data }) {
  if (!data) return null;
  
  return (
    <div>
      <h2 className="text-2xl font-bold mb-5">ðŸ“Š Resum de Progressos</h2>
      
      {/* Mitjanes */}
      <div className="bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-6 rounded-xl mb-6">
        <h3 className="text-xl font-bold mb-4">ðŸ“ˆ Mitjana Intents per Truc</h3>
        {data.tricks.map((trick, i) => {
          const nums = Object.values(trick.attempts).filter(a => a && a !== 'â€”' && a !== '+5').map(a => parseInt(a));
          if (nums.length === 0) return null;
          const avg = nums.reduce((a,b) => a+b, 0) / nums.length;
          const pct = ((6 - avg) / 5) * 100;
          let color = '#9CA3AF';
          if (avg <= 1.5) color = '#10B981';
          else if (avg <= 2.5) color = '#34D399';
          else if (avg <= 3.5) color = '#FBBF24';
          else if (avg <= 4.5) color = '#FB923C';
          else color = '#F87171';
          
          return (
            <div key={i} className="flex items-center gap-4 mb-3">
              <div className="w-24 text-sm font-semibold truncate">{trick.name}</div>
              <div className="flex-1 h-8 bg-white bg-opacity-20 rounded-full overflow-hidden">
                <div style={{width: `${pct}%`, background: color}} className="h-full flex items-center justify-end px-2 text-white font-bold text-sm">
                  {pct > 15 && avg.toFixed(1)}
                </div>
              </div>
              <div className="w-12 text-right font-bold text-sm">{avg.toFixed(1)}</div>
            </div>
          );
        })}
      </div>
      
      {/* Taula */}
      <div className="bg-white border border-gray-200 rounded-xl p-6">
        <h3 className="text-xl font-bold mb-4">ðŸ“… ProgressiÃ³ per Sessions</h3>
        <div className="overflow-x-auto">
          <table className="w-full">
            <thead>
              <tr className="bg-gray-50">
                <th className="px-4 py-2 text-left text-sm font-semibold">Truc</th>
                {data.sessions.map((s, i) => <th key={i} className="px-4 py-2 text-center text-sm font-semibold">{s}</th>)}
              </tr>
            </thead>
            <tbody>
              {data.tricks.map((trick, i) => (
                <tr key={i} className="border-t">
                  <td className="px-4 py-2 font-semibold bg-gray-50">{trick.name}</td>
                  {data.sessions.map((s, si) => {
                    const att = trick.attempts[s];
                    const colors = {
                      '1': 'bg-green-100 text-green-800',
                      '2': 'bg-green-50 text-green-700',
                      '3': 'bg-yellow-100 text-yellow-800',
                      '4': 'bg-orange-100 text-orange-800',
                      '5': 'bg-red-100 text-red-700',
                      '+5': 'bg-red-200 text-red-900'
                    };
                    return (
                      <td key={si} className="px-4 py-2 text-center">
                        <span className={`inline-block px-3 py-1 rounded font-semibold text-sm ${colors[att] || 'bg-gray-100 text-gray-400'}`}>
                          {att || 'â€”'}
                        </span>
                      </td>
                    );
                  })}
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  );
}

function AddTrickModal({ onClose, onAdd }) {
  const [name, setName] = useState('');
  const [level, setLevel] = useState('mitja');
  const [group, setGroup] = useState('flatground');
  
  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onClick={onClose}>
      <div className="bg-white p-8 rounded-2xl max-w-md w-full" onClick={e => e.stopPropagation()}>
        <h2 className="text-2xl font-bold text-indigo-600 mb-5">Afegir Nou Truc</h2>
        <input
          type="text"
          placeholder="Nom del truc..."
          className="w-full px-4 py-3 border-2 border-gray-200 rounded-lg mb-4"
          value={name}
          onChange={e => setName(e.target.value)}
        />
        <select className="w-full px-4 py-3 border-2 border-gray-200 rounded-lg mb-4" value={level} onChange={e => setLevel(e.target.value)}>
          <option value="facil">FÃ cil</option>
          <option value="mitja">MitjÃ </option>
          <option value="dificil">DifÃ­cil</option>
        </select>
        <select className="w-full px-4 py-3 border-2 border-gray-200 rounded-lg mb-4" value={group} onChange={e => setGroup(e.target.value)}>
          {Object.entries(GROUPS).map(([k, v]) => <option key={k} value={k}>{v}</option>)}
        </select>
        <div className="flex gap-3 justify-end">
          <button className="px-6 py-3 bg-gray-200 rounded-lg font-semibold" onClick={onClose}>CancelÂ·lar</button>
          <button className="px-6 py-3 bg-indigo-600 text-white rounded-lg font-semibold" onClick={() => name && onAdd({name, level, group, attempts: {}})}>Afegir</button>
        </div>
      </div>
    </div>
  );
}

function AddSessionModal({ onClose, onAdd }) {
  const [name, setName] = useState('');
  
  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onClick={onClose}>
      <div className="bg-white p-8 rounded-2xl max-w-md w-full" onClick={e => e.stopPropagation()}>
        <h2 className="text-2xl font-bold text-indigo-600 mb-5">Afegir Nova SessiÃ³</h2>
        <input
          type="text"
          placeholder="Nom de la sessiÃ³..."
          className="w-full px-4 py-3 border-2 border-gray-200 rounded-lg mb-4"
          value={name}
          onChange={e => setName(e.target.value)}
        />
        <div className="flex gap-3 justify-end">
          <button className="px-6 py-3 bg-gray-200 rounded-lg font-semibold" onClick={onClose}>CancelÂ·lar</button>
          <button className="px-6 py-3 bg-indigo-600 text-white rounded-lg font-semibold" onClick={() => name && onAdd(name)}>Afegir</button>
        </div>
      </div>
    </div>
  );
}

function AddSkaterModal({ onClose, onAdd }) {
  const [name, setName] = useState('');
  const [age, setAge] = useState('');
  
  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onClick={onClose}>
      <div className="bg-white p-8 rounded-2xl max-w-md w-full" onClick={e => e.stopPropagation()}>
        <h2 className="text-2xl font-bold text-indigo-600 mb-5">Afegir Nou Skater</h2>
        <input
          type="text"
          placeholder="Nom del skater..."
          className="w-full px-4 py-3 border-2 border-gray-200 rounded-lg mb-4"
          value={name}
          onChange={e => setName(e.target.value)}
        />
        <input
          type="number"
          placeholder="Edat..."
          className="w-full px-4 py-3 border-2 border-gray-200 rounded-lg mb-4"
          value={age}
          onChange={e => setAge(e.target.value)}
        />
        <div className="flex gap-3 justify-end">
          <button className="px-6 py-3 bg-gray-200 rounded-lg font-semibold" onClick={onClose}>CancelÂ·lar</button>
          <button className="px-6 py-3 bg-indigo-600 text-white rounded-lg font-semibold" onClick={() => name && onAdd({name, age: age ? parseInt(age) : null})}>Afegir</button>
        </div>
      </div>
    </div>
  );
}
